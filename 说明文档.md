### 实现功能

1. 玩家操控一位初始角色，鼠标移动控制角色的瞄准方向，左键射击/捡起武器，右键技能，C键切换武器，靠近敌人攻击方式变手刀；
2. 地图共1个小关，有5个房间分别为：初始房间、两个怪物房间、宝箱房间和最后的传送房间；
3. 怪物房间会遇到不同的敌人，共5种：野猪、手枪哥布林、弓箭哥布林、长矛哥布林和哥布林祭祀，每种敌人攻击方式不同；
4. 进入怪物房间后，房间门会自动关上，直至击败所有波次的敌人；
5. 击败每个怪物后掉落能量和金币，靠近会自动吸取，击败所有敌人后房间生成一个宝箱（有武器/血瓶）；
6. 宝箱内有不同的武器，各自的攻击模式不同，一种攻击模式不止一把武器；
7. 传送房间回到主菜单页面；

### 如何实现

1. 实现一个骑士角色，初始携带破旧的手枪，用WSAD控制角色八向移动，鼠标移动控制人物的瞄准方向，左键开火，右键技能；

   - **角色移动**

     InputGetAxisRaw得到在水平、垂直方向上的输入值，在FixedUpdate中不断更新RigidBody2D的位置，当鼠标在角色左侧时需翻转Sprite；（这样有个问题就是斜着走比横竖走更快些）

   - **鼠标控制瞄准方向**

     先获取鼠标在世界坐标系下的坐标，然后使武器的transform.right一直指向其坐标，同样当鼠标在武器左侧时需翻转Sprite；

   - **左键开火**

     角色持有一个武器物体，点击左键时将调用武器物体脚本下的Shoot方法进行攻击；

   - **右键技能**

     技能条使用SliderBar实现。角色挂载一个子物体用来播放技能动画，使用技能时，播放子物体的动画，同时根据角色目前持有的武器再生成一个一样的武器挂载到角色身上；技能时间到后，将销毁生成的武器。注意使用技能时切换武器将直接退出技能（原游戏也如此设定）

2. 实现森林大关的第一个小关（1-1关），该关卡包括若干房间；

   - **地图**

     采用了TileMap制作地图，由于元气骑士的地图看起来具有立体效果，这里用到了4层TileMap分别为Top(顶面)、Wall(墙)、Shadow(阴影)、Tile(地板)，图层的遮罩关系为：Top > Wall > Shadow > Tile。

3. 实现手枪哥布林、弓箭哥布林、长矛哥布林、野猪、哥布林祭祀5种怪物；

   - **A*自动寻路AI**

     用到了A*Pathfinding包，通过其接口获取到达目标点的一系列路径点，通过维护下一个路径点来控制怪物向下一个地方移动；

   - **怪物AI**

     Idle状态：敌人静止不动，播放Idle动画；

     巡逻状态：当角色进入房间后怪物进入巡逻状态。怪物会以自身为起点，巡逻半径的一个圆内随机选择一点作为下一个目标点；

     跟踪状态：角色进入怪物视野后(Raycast实现)，开始跟踪角色；若丢失视野重新进入巡逻；

     攻击状态：怪物跟踪角色直至达到攻击距离时开始攻击角色，若二者距离大于攻击距离则继续跟踪；

     死亡状态：怪物HP < 0 时进入死亡状态。

   - **具体怪物实现**

     手枪哥布林、弓箭哥布林、长矛哥布林、野猪、哥布林祭祀5种怪物，除了野猪行为简单只有Idle、巡逻状态、死亡状态外，其他怪物行为逻辑一样，即上述5中状态，但各自攻击方式不同，攻击方式取决于各自的武器。武器的实现在8中细述。

3. 实现场景中可被破坏的木箱；

   - **破坏木箱**

     木箱为一个具有Sprite和BoxCollider2D的物体放置在房间内，当具有攻击属性的物体检测到木箱进入Collider2D时，会调用木箱的<被攻击接口>，而木箱在其被攻击接口内则销毁自身。

5. 房间机关——门的实现；

   - **机关门**

     门有打开/关闭两个动画，以及Open、Close两个方法，Open方法播放打开动画，同时禁用所有子物体Collider2D，Close方法播放关闭动画，同时启用所有子物体Collider2D。每个房间有个Collider2D作为Trigger，当角色进入房间后，房间脚本会调用门的方法。

6. 击杀怪物掉落能量和金币，人物靠近可以吸取；

   - **掉落能量和金币**

     怪物HP <= 0 会在自身位置生成相应数量的金币和能量Prefab

   - **靠近吸取**

     金币和能量的脚步通过判断角色是否在可吸取范围内，若在则通过Vertor3.Lerp插值使金币和能量向角色先快后慢的移动来实现吸引效果，当金币和能量离角色距离足够近时，销毁物体。

7. 击杀一个房间的所有怪物后会生成一个奖励箱子；

   - **生成奖励箱子**

     怪物房间下挂载一个空物体作为箱子Prefab的生成点，当怪物清空时在空物体处生成箱子。

   - **奖励箱子**

     当角色靠近箱子Trigger范围时，播放打开动画，同时使其子物体（武器）SetActive为true。

8. 多个波次敌人的生成；

   - **多波次敌人生成**

     怪物房间下挂载几个空物体作为每轮怪物的生成点，同时维护一个怪物列表，每一轮时，随机从几类怪物中选取几个生成，并加到怪物列表中，当怪物死亡时会从列表中移除，当列表为空则一轮结束。

9. 若干种武器，实现拾取武器，切换主副手武器等功能。武器覆盖不同的攻击模式，每一种攻击模式不止有一把武器。

   - **武器实现**

     采用继承实现。武器类中存在虚方法Shoot，当要实现不同攻击模式的武器时，继承并重写Shoot方法。同时武器还存在一个子弹物体成员变量，赋予不同的子弹Prefab能实现不同的攻击效果。

   - **拾取武器**

     角色向周围发射射线（OverlapCircle）检测是否有Tag为"Weapon"的碰撞体，当副武器为null时，直接捡起，同时禁用其Sprite和Collider，当主副武器皆不为null时，放下当前的武器(SetParent)，启用其Collider，同时将地上的武器设为自己的子物体。 

   - **切换武器**

     用一个大小为2的数组存放主副武器，同时维护一个int变量表明当前使用哪个武器物体，和维护一个Weapon类变量。当切换武器时，将当前武器的sprite禁用，将另一把武器的sprite启用，同时赋予Weapon类变量新的值。

10. 玩家离怪物距离较近且携带的不是近战武器时，攻击方式变为手刀；

    - **手刀攻击**
      和拾取武器一样，采用OverlapCircle检测是否有Tag为"Monster"的碰撞体，当存在时设置一个bool变量为true，并在点击左键攻击时判断这个bool变量，为true则使用手刀否则使用武器。

11. UI界面：菜单界面和主界面；

    - **UI**

      采用SceneManager类下的方法。

### 用到的插件/包

- A*Pathfinding
- Cinemachine

### 代码架构

![](D:\Unity\元气骑士复刻\Images\代码架构.png)
